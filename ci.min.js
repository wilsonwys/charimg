var CI=function(){function c(){if(b&&b.url!=a.workerJs&&(b=null),!b&&a.workerJs&&"undefined"!=typeof Worker)try{b=new Worker(a.workerJs),b.addEventListener("message",function(a){b.handle&&b.handle(null,a.data)},!1),b.addEventListener("error",function(c){b.handle&&b.handle(c),a.onerror&&a.onerror(c),b=a.workerJs=null},!1),b.on=function(a){b.handle=a},b.url=a.workerJs}catch(c){a.onerror&&a.onerror(c),b=a.workerJs=null}return b}function e(e,f,g){if(c(),a.workerJs&&b)try{b.on(function(b,c){if(b)a.onerror&&a.onerror(b),d[e].call(null,f,g);else{if(c)for(var h in c)c[h]&&f[h]&&c[h]instanceof Array&&(f[h].length=0,c[h]=$.extend(f[h],c[h]));g(c)}}),b.postMessage({algName:e,opts:f})}catch(h){a.onerror&&a.onerror(h)}else d[e].call(null,f,g)}function f(a,b,c){function f(){if(d++,d<b.length){var g=b[d];"function"==typeof g?g.call({index:d+1,count:b.length},e,function(b,d){b?c&&c(b,e):(e=d,a?setTimeout(f,0):f())}):f()}else c&&c(null,e)}("function"==typeof a||a instanceof Array)&&(c=b,b=a,a=!1),"function"==typeof b?b=[b]:b||(b=[]),"function"!=typeof c&&(c=null);var e,d=-1;f()}function g(a){return a&&/^img|canvas$/i.test(a.tagName)}var b,a={async:!1,workerJs:null,random:!1,orientation:!1,minWidth:150,minHeight:150,fontFamily:["黑体"],minFontSize:12,fontZoom:10,fontColor:"#000000",square:!1,useOnes:!1,backgroundColor:"#ffffff",shadowColor:"#000000",onerror:null},d={mosaic:function(a,b){var o,p,q,r,s,t,x,u,v,w,y,z,A,B,C,c=a.imageData,d=c.data,e=a.indexTable,f=a.width,g=4*f,h=a.height||parseInt(d.length/g),i=parseInt(a.size)||7,j=i*i,k=i*g,l=4*i,m="threshold"in a,n=a.threshold>0?765*a.threshold:382.5;for(o=0,p=0,q=0;h>o;o+=i,p+=k,q++)for(r=0,s=p,t=0;f>r;r+=i,s+=l,t++){for(u=[0,0,0],v=f-r,w=h-o,i>v||i>w?(i>v||(v=i),i>w||(w=i),x=v*w):(v=i,w=i,x=j),y=0,z=s;w>y;y++,z+=g)for(A=0,B=z;v>A;A++,B+=4)0==d[B+3]?(u[0]+=255,u[1]+=255,u[2]+=255):(u[0]+=d[B],u[1]+=d[B+1],u[2]+=d[B+2]);if(m?(u[0]=(u[0]+u[1]+u[2])/x,u[0]=u[1]=u[2]=u[0]>n?255:0):(u[0]=parseInt(u[0]/x),u[1]=parseInt(u[1]/x),u[2]=parseInt(u[2]/x)),e&&(e[q]||(e[q]=[]),e[q][t]=u),!a.notWrite)for(y=0,z=s;w>y;y++,z+=g)for(A=0,B=z;v>A;A++,B+=4)d[B]=u[0],d[B+1]=u[1],d[B+2]=u[2]}return C={imageData:c,indexTable:e},b&&b(C),C},layout:function(b,c){function l(a,b,c){var g,h,d=[],e=c?2:4,f=c?3:5;for(g=0;g<a.length;g++)h=a[g],h.forEach(function(a){b[Math.ceil(a[f])]>=a[e]&&(a[8]=g,d.push(a))});return d}var m,n,o,p,q,r,s,v,t,u,w,x,y,d=b.renderTable,e=b.indexTable,f=b.wordList,g=b.maxWidth,h=b.maxHeight,i=b.fontSize,j=b.vertical,k=b.useOnes;for(m=0;m<e.length&&f.length;m++)for(n=0;n<e[m].length&&f.length;n++)if(e[m][n]&&0==e[m][n][0]){for(o={},p=0,q=Math.min(e.length-m,h);q>p;p++){for(r=0,s=Math.min(g,e[p].length-n,o[p]?o[p]:e[p].length);s>r&&e[m+p][n+r]&&0==e[m+p][n+r][0];r++)o[p+1]=r+1;if(!o[p+1])break}if(t=0==j||Math.random()>=j,u=l(f,o,t),t||u&&u.length||(t=!t,u=l(f,o,t)),u.length&&(v=u.length*Math.random(),a.random||(v*=Math.random()),u=u[parseInt(v)])){if(w=n*i,x=m*i,null!=u[7]?d.push([null,w,x,u[2],u[3],u[7]]):((u[6]>0||u[6]<0)&&(x-=u[6]),d.push([u[0],w,x,u[1],t?0:u[3]*i])),k&&(f.splice(u[8],1),!f.length))break;for(q=t?u[3]:u[5],s=t?u[2]:u[4],p=0;q>p;p++)for(r=0;s>r;r++)e[m+p]&&(e[m+p][n+r]=null);n+=parseInt(s-1)}}else e[m][n]=null;return y={renderTable:d},c&&c(y),y}};return"undefined"==typeof window&&(this.window=this.document={},this.onmessage=function(a){a.data.algName&&d[a.data.algName]?d[a.data.algName].call(null,a.data.opts,function(a){postMessage(a)}):postMessage(a.data.opts)}),window.URL||(window.URL=window.webkitURL),{setting:a,covenToArray:function(a){return a instanceof Array?a:[a]},getFileUrl:function(a,b,c){var d,e;"function"==typeof b&&(c=b,b=null);try{!/FileReader/.test(b)&&window.URL?(d=window.URL.createObjectURL(a),c&&c(null,d)):(e=new FileReader,e.onload=function(){c&&c(null,this.result)},e.onerror=function(){c&&c("FileReader解析失败")},e.readAsDataURL(a))}catch(f){c&&c(f)}},openImgUrl:function(a,b){if(a){var c=new Image;c.onload=function(){b&&b(null,c)},c.onerror=function(){b&&b("error")},c.src=a}},parseImgOrientation:function(a,b){function d(b,d,e){c.onload=function(){var c,d;if(this.result&&this.result.byteLength>0)try{d=new Uint8Array(this.result,b,this.result.byteLength)}catch(f){c=f}else c="File End";e&&e(c,b,d)};try{var f=a;a.slice&&(f=a.slice(b,d),b=0),c.readAsArrayBuffer(f)}catch(g){e&&e(g)}}function e(a,b,c,d){var f,e=0;for(c=c>0?c:0,d=d>0?d:b.length-c,f=0;d>f;f++)e<<=8,e+=b[a?c+f:c+d-f-1];return e}function f(a,b,c){255==b[0]&&225==b[1]?69==b[4]&&120==b[5]&&105==b[6]&&102==b[7]?c&&c(null,a+10,Array.prototype.slice.call(b,10)):c&&c("Not Exif"):(a+=e(!0,b,2,2)+2,d(a,8e3,function(a,b,d){a?c&&c(a):f(b,d,c)}))}var c=new FileReader;d(0,8e3,function(a,c,d){d&&255==d[0]&&216==d[1]?(c+=2,f(c,Array.prototype.slice.call(d,2),function(a,c,d){var f,g,h,i,j,k;if(a)return b&&b("No Exif");if(73==d[0]&&73==d[1])f=0;else{if(77!=d[0]||77!=d[1])return b&&b("Unknown Endian");f=1}for(g=e(f,d,4,4),h=e(f,d,g,2),g+=2,i=0;h>i;i++){if(j=e(f,d,g,2),274==j)return k=e(f,d,g+8,2),b&&b(null,k);g+=12}b&&b(null,0)})):b&&b("Not jpeg")})},openImgFile:function(b,c,d){"function"==typeof c&&(d=c,c=null),c||(c={});var f,e=this,g=null==c.orientation?a.orientation:c.orientation;!b||!/image/.test(b.type)&&b.type?b&&d&&d("请选择图片文件"):this.getFileUrl(b,f,function(f,h){f?d&&d(f):e.openImgUrl(h,function(f,h){f?d&&d(f):g?e.parseImgOrientation(b,function(b,c){var f,g,i,j;if(b)a.onerror&&a.onerror(b),f=e.loadImgToCanvas(h).canvas;else{switch(g=h.width,i=h.height,c>=5&&8>=c&&(g=h.height,i=h.width),f=e.createCanvas(g,i),j=f.getContext("2d"),c){case 2:j.translate(g,0),j.scale(-1,1);break;case 3:j.translate(g,i),j.rotate(Math.PI);break;case 4:j.translate(0,i),j.scale(1,-1);break;case 5:j.rotate(.5*Math.PI),j.scale(1,-1);break;case 6:j.rotate(.5*Math.PI),j.translate(0,-h.height);break;case 7:j.rotate(.5*Math.PI),j.translate(g,-h.height),j.scale(-1,1);break;case 8:j.rotate(-.5*Math.PI),j.translate(-h.width,0)}j.drawImage(h,0,0,h.width,h.height)}d&&d(null,f)}):d&&d(null,"canvas"==c.type?e.loadImgToCanvas(h).canvas:h)})})},loadImgToCanvas:function(b,c){var d,e,f,g,h,i,j,k;return c||(c={}),d=c.width||b.width,e=c.height||b.height,d<a.minWidth&&(e=parseInt(a.minWidth*e/d),d=a.minWidth),e<a.minHeight&&(d=parseInt(a.minHeight*d/e),e=a.minHeight),f=c.canvas?c.canvas:this.createCanvas(d,e,c.viewWidth,c.viewHeight),g=f.getContext("2d"),h=0,i=0,j=d,k=e,(j!=b.width||k!=b.height)&&(j=d/b.width,k=e/b.height,j>k?(j=k*b.width,k=e,h=(d-j)/2):(k=j*b.height,j=d,i=(e-k)/2)),c.backgroundColor&&(g.fillStyle=c.backgroundColor,g.fillRect(0,0,d,e)),g.drawImage(b,h,i,j,k),{canvas:f,width:d,height:e,originalWidth:b.width,originalHeight:b.height}},createCanvas:function(a,b,c,d,e){var f,g,h;return"object"==typeof a&&a&&a.width&&(f=a.backgroundColor,e=a.name,c=a.viewWidth,d=a.viewHeight,b=a.height,a=a.width),g=document.createElement("canvas"),a>0&&(g.width=a,b>0||(b=a)),b>0&&(g.height=b),c&&(g.style.width=c+(c>0?"px":"")),d&&(g.style.height=d+(d>0?"px":"")),e&&g.setAttribute("data-name",e),f&&(h=g.getContext("2d"),h.fillStyle=f,h.fillRect(0,0,g.width,g.height)),g},createBgCanvas:function(a,b,c,d){"object"==typeof a&&a&&a.width&&(c=a.viewWidth,d=a.viewHeight,b=a.height,a=a.width);var e=this.createCanvas(a,b,c,d),f=this.createCanvas(40,40),g=f.getContext("2d");return g.fillStyle="#fff",g.fillRect(0,0,40,40),g.fillStyle="rgba(220,220,220,.5)",g.fillRect(20,0,20,20),g.fillRect(0,20,20,20),g=e.getContext("2d"),g.fillStyle=g.createPattern(f,"repeat"),g.fillRect(0,0,a,b),e},woodcut:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(b=$.extend({},b),c=a.getContext("2d"),d=c.getImageData(0,0,a.width,a.height),e=d.data,f=b.pR||0,g=b.pG||0,h=b.pB||0,i=null!=b.pA?b.pA:255,j=null!=b.bR?b.bR:255,k=null!=b.bG?b.bG:255,l=null!=b.bB?b.bB:255,m=null!=b.bA?b.bA:255,n=b.threshold>0?765*b.threshold:382.5,o=0,p=e.length;p>o;o+=4)0==e[o+3]||e[o]+e[o+1]+e[o+2]>n?(e[o]=j,e[o+1]=k,e[o+2]=l,e[o+3]=m):(e[o]=f,e[o+1]=g,e[o+2]=h,e[o+3]=i);b.target&&(c=b.target.getContext("2d")),c.putImageData(d,0,0)},mosaic:function(a,b,c){var d,f;b=$.extend({},b),"IMG"==a.tagName&&(d=this.loadImgToCanvas(a,{width:a.width,height:height}),a=d.canvas),f=a.getContext("2d"),e("mosaic",{imageData:f.getImageData(0,0,a.width,a.height),width:a.width,height:a.height,size:b.size,threshold:b.threshold,indexTable:b.indexTable,notWrite:b.notWrite},function(a){b.notWrite||(b.target&&(f=b.target.getContext("2d")),f.putImageData(a.imageData,0,0)),c&&c(a)})},getFontDeviation:function(a,b){var f,g,h,i,j,c=CI.createCanvas(),d=c.getContext("2d"),e=12;for(c.width=e,c.height=3*e,d.textBaseline=b||"top",d.font=e+"px "+a,d.fillStyle="#fff",d.fillText("─",0,e),f=d.getImageData(parseInt(c.width/2),0,1,c.height),g=f.data,h=0,i=0,j=g.length;j>i;i+=4)if(h++,g[i]>128)return(h-1.5*e)/e;return 0},measureText:function(b,c,d,e,f,h){var k,l,m,i=this,j=[];return b=[].concat(this.covenToArray(b)),c=this.covenToArray(c),d=d>a.minFontSize?d:a.minFontSize,e=e>=1?e:1,f||(f=[]),k={},c.forEach(function(a){k[a]=i.getFontDeviation(a,"top")}),l=this.createCanvas(),m=l.getContext("2d"),b.forEach(function(a){var i,l,n,b=[];if(j.push(b),g(a))for(i=f.length,l=1,f.push(a),h||(l=a.height/a.width),n=e;n>0;n--)b.push([null,null,n,l*n,n,l*n,null,i]);else(a=(""+a).trim())&&c.forEach(function(c){var g,h,i,j,l,f=[];for(g=1;e>=g;g++)f[g]=d*g+"px / "+d*g+"px "+c;for(m.font=d+"px / "+d+"px "+c,h=0,i=0,j=a.length,g=0;j>g;g++)l=m.measureText(a.charAt(g)).width,h+=l,l>i&&(i=l);for(h/=d,i/=d,g=e;g>0;g--)b.push([a,f[g],h*g,g,i*g,j*g,k[c]?parseInt(k[c]*d*g):0])})}),j},createCharImg:function(b,c){var h,i,g=this;return c=$.extend({},c),h="function"==typeof c.onprogress?c.onprogress:null,onended="function"==typeof c.onended?c.onended:null,wordList=c.wordList,indexTable=c.indexTable&&c.indexTable instanceof Array?c.indexTable:[],renderTable=c.renderTable&&c.renderTable instanceof Array?c.renderTable:[],fontFamily=c.fontFamily||a.fontFamily,fontSize=c.fontSize>a.minFontSize?c.fontSize:a.minFontSize,fontZoom=c.fontZoom>=1?c.fontZoom:a.fontZoom,fontColor=c.fontColor||a.fontColor,backgroundColor=c.backgroundColor||a.backgroundColor,shadowColor=c.shadowColor||a.shadowColor,square=null!=c.square?c.square:a.square,useOnes=null!=c.useOnes?c.useOnes:a.useOnes,vertical=c.vertical>0?Math.min(1,c.vertical):0,threshold=c.threshold>=0?c.threshold:.5,i=b.getContext("2d"),f(a.async,[function(a,b){var d=this;0==renderTable.length&&0==indexTable.length?g.mosaic(c.img,{threshold:threshold,size:fontSize,indexTable:indexTable,notWrite:1},function(){h&&h.call(d),b()}):b()},function(a,b){var d,e,c=this;if(0==renderTable.length){for(a={maxWidth:0,maxHeight:0,imglist:[]},wordList=g.measureText(wordList,fontFamily,fontSize,fontZoom,a.imglist,square),d=0;d<wordList.length;d++)e=wordList[d],e.forEach(function(b){b[2]>a.maxWidth&&(a.maxWidth=b[2]),b[5]>a.maxHeight&&(a.maxHeight=b[5])});h&&h.call(c),b(null,a)}else b()},function(a,b){var f,c=this;0==renderTable.length?(this.index,f=a.imglist,e("layout",{indexTable:$.extend(!0,[],indexTable),renderTable:renderTable,wordList:wordList,maxWidth:a.maxWidth,maxHeight:a.maxHeight,fontSize:fontSize,vertical:vertical,useOnes:useOnes},function(){renderTable.forEach(function(a){null!=a[5]&&(a[0]=f[a[5]],a[3]=Math.round(a[3]*fontSize),a[4]=Math.round(a[4]*fontSize))}),h&&h.call(c),b()})):b()},function(a,d){var e=this;i.fillStyle=backgroundColor,i.fillRect(0,0,b.width,b.height),c.backgroundImg&&/^(img|canvas)$/i.test(c.backgroundImg.tagName)&&(i.globalAlpha=c.backgroundImgOpacity>=0?c.backgroundImgOpacity:1,i.drawImage(c.backgroundImg,0,0,b.width,b.height),i.globalAlpha=1),h&&h.call(e),d()},function(a,d){var j,f,k,l,m,e=this;c.shadowOpacity>0&&(f=g.createCanvas(b.width,b.height),k=0,l=0,m=0,(j=(""+shadowColor).match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i))&&(k=parseInt(j[1],16),l=parseInt(j[2],16),m=parseInt(j[3],16)),g.woodcut(c.img,{target:f,pR:k,pG:l,pB:m,pA:0|255*c.shadowOpacity,bA:0}),i.globalAlpha=c.shadowOpacity,i.drawImage(f,0,0,b.width,b.height),i.globalAlpha=1,h&&h.call(e)),d()},function(a,b){var c=this;i.fillStyle=fontColor,i.textBaseline="top",renderTable.forEach(function(a){var b,c,d;if(null!=a[5])a[0]&&i.drawImage(a[0],0,0,a[0].width,a[0].height,a[1],a[2],a[3],a[4]);else if(i.font=a[3],a[4]>0)for(b=a[2],c=0,d=a[0].length;d>c;c++)i.fillText(a[0].charAt(c),a[1],b),b+=a[4];else i.fillText(a[0],a[1],a[2])}),h&&h.call(c),b()},function(a,d){var e=this;c.watermarkImg&&/^(img|canvas)$/i.test(c.watermarkImg.tagName)&&(i.globalAlpha=c.watermarkImgOpacity>=0?c.watermarkImgOpacity:1,i.drawImage(c.watermarkImg,0,0,b.width,b.height),i.globalAlpha=1),h&&h.call(e),d()}],function(){onended&&onended()},!0),g}}}();
